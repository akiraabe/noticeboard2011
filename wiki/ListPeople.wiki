#summary 行き先表示板の出力
コード説明のTOPへ ExplanationOfSourceCode
<br/>
前のページへ CreatePerson
<br/>
次のページへ UpdatePlace 
<hr/>
= 行き先表示板の出力機能の説明 =

行き先表示板出力機能の説明

== 前提知識 ==
ここでは、以下の要素技術を使っている。
  * jQuery
  * flexigrid(jQuery Plugin)
  * jQuery UI Dialog
  * JSON
  * JSONIC（JSONのパーサ）
各々についての参考URLを下記する。<br/><br/>

=== jQuery ===
本家 http://jquery.com/
<br/>
日本語リファレンス http://semooh.jp/jquery/

=== flexigrid ==
本家 http://www.flexigrid.info/
<br/>
マイコミジャーナルの紹介記事 http://journal.mycom.co.jp/articles/2008/06/25/flexigrid/index.html

=== jQuery UI Dialog ===
http://jqueryui.com/demos/dialog/
<br/>
jQuery UIの紹介記事（技術評論社） http://gihyo.jp/dev/feature/01/jquery-ajax/0005
=== JSON ===
JSONの紹介 http://www.json.org/json-ja.html

=== JSONIC（JSONのパーサ） ===
http://jsonic.sourceforge.jp/
<br/>
マイコミジャーナルの紹介記事 http://journal.mycom.co.jp/articles/2008/04/09/jsonic/index.html

== 処理の流れ ==
  # アクターは、http://noticeboard2011.appspot.com/ のURLでシステムにリクエストする。
    # index.htmlはflexigridによりhtmlのテーブルのDOMオブジェクト(#tabledata)を生成する。
  # #tabledataは、!IndexControllerへpostする。
  # !IndexControllerは以下の操作を順に行う。
    # privateメソッドのgetPersonListを呼び出し、人の一覧を取得する。
      # PersonServiceのgetPersonListメソッドに委譲する。
    # privateメソッドのgenerateJsonDataを呼び出し、JSON形式のデータ（ValueObject）を生成する。
    # Superクラスのjsonメソッドを呼び出し、JSON形式のデータを出力する。
  # index.htmlのpreProcess()は、サーバサイドから受け取ったJSON形式データを加工し、行き先欄をリストボックス形式に変換する。
  # index.htmlのpostProcess()は、行き先の背景色を設定する。

== ソースコード ==
=== index.html ===
{{{
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>noticeboard2011</title>
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<link href="css/flexigrid/flexigrid.css" rel="stylesheet"
	type="text/css">
<link type="text/css" href="css/smoothness/jquery-ui-1.8.7.custom.css"
	rel="stylesheet" />
<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script> <script
	type="text/javascript" src="js/jquery-ui-1.8.7.custom.min.js"></script>
<script type="text/javascript" src="js/flexigrid.pack.js"></script> <script
	type="text/javascript">
<!--
/*  
 * ページのLoad時に呼び出される処理
 */
$(document).ready(function() {
	$("#datatable").flexigrid({ // id="datatable"のtableタグに対して、flexigridを適用する
		autoload: true, // HTML表示時に自動的に読み込みを開始するかどうか。
		url: "index", // Ajax でリクエストされるURL。XML もしくは JSON 出力
		method: "post", // 送信メソッド（デフォルトはpost）
		dataType: "json", // 読み込むデータのタイプ。（json or xml）
		/*
		colModel
			列の設定オブジェクトをもつ配列
			display：列の表示名
			name：列のユニークID（テーブルカラム名）必須
			width：列幅
			sortable：列のソートを有効にするかどうか
			align：文字の配置
			hide：非表示にするかどうか
		*/
		colModel: [
					{display: "id", name : "id", width : 30, sortable : false, align: "center", hide : false},
					{display: "version", name : "version", width : 50, sortable : false, align: "center", hide : true},
					{display: "ファーストネーム", name : "firstName", width : 150, sortable : true, align: "center"},
					{display: "ラストネーム", name : "lastName", width : 150, sortable : false, align: "center"},
					{display: "行き先", name : "place", width : 100, sortable : false, align: "center"},
					{display: "hidden", name : "place2", width : 10, sortable : false, align: "center", hide: true}
		],
		/*
		buttons
			ヘッダにボタンを表示する際のボタン情報を格納した配列
			name：ボタン表示文字
			bclass：ボタンの表示クラス
			onpress：ボタンを押された際に呼び出されるメソッド
			separator：セパレータを表示
		*/
		buttons : [
					{name: 'Add', bclass: 'add', onpress : test},
					{name: 'Edit', bclass: 'edit', onpress : editPressed},
					{name: 'Delete', bclass: 'delete', onpress : deletePressed},
					{separator: true}
		],
		/*
		searchitems
			検索対象となる列の配列
			display：検索対象を選択するセレクトボックスの表示文字
			name：列のユニークID（テーブルカラム名）必須
			isdefault：初期選択されているかどうか。
		*/
		searchitems : [  
             {display: 'ファーストネーム', name : 'firstName'}
        ],  
		usepager: true, // ページャーを使用するかどうか。
		title: "noticeboard", // テーブルのキャプション。設定するとタイトル行が表示される。
		useRp: true, // 1ページに表示する行数を変更できるセレクトボックスを表示するかどうか。
		rp: 10, // 1ページに表示する行数。
		rpOptions: [3,5,10,20,30], // useRp を有効にした際のセレクトボックス値の配列。
		pagestat: "{from} ～ {to} を表示 (総数: {total} )", // 現在表示しているページの説明文フォーマット。表示開始行：{from}、表示終了行：{to}、総数：{total}が利用できる。
		procmsg: "しばらくお待ちください……", // 読み込み中時フッターに表示されるメッセージ。
		nomsg: "項目はありません。", // 検索データが存在しなかった場合のメッセージ。
		showTableToggleBtn: true, // テーブルの表示非表示ボタンを設置するかどうか。title に文字が設定されている場合のみ有効。
		singleSelect: true, // 行の複数選択を可能にするかどうか。
		width: 500, // テーブルの横幅。数値もしくは auto が利用可能。auto に設定した際は横のリサイズは無効。
		height: "auto", // テーブルの高さ。数値もしくは auto が利用可能。auto に設定した際は縦のリサイズは無効。
		preProcess: preProcess // データを受信した直後にデータを成形するため（と思われる）に呼び出される。
		,onSuccess: postProcess // 表示が成功した際に呼び出されるイベントハンドラメソッド。
	});

	//リストボックスで値を変更したら、update関数を呼び出す。
	$("#datatable").change(update);

	//編集ダイアログの準備
	$("#edit-dialog").dialog({ // id="edit-dialog"のdivタグに対して、dialogを適用する
		modal:true, // モーダル画面にするかどうか。
		autoOpen:false, // 自動的にダイアログを開くかどうか。
		resizable:false, // リサイズを可能とするかどうか。
		draggable:true, // ドラッグを可能とするかどうか。
		title:"編集入力",
		width: 450,
		show:"scale", // ダイアログを表示するときの効果。
		hide:"scale", // ダイアログを閉じるときの効果。
		buttons: { // ボタンの配置と押したときの振る舞いを定義する。
		"OK": function() {
			// ダイアログに入力された値を変数に保存
			var id = $("#id").val();
			var firstName = $("#firstNameInput").val();
			var lastName = $("#lastNameInput").val();
			//alert('id:' + id + ' name:' + firstName + lastName);
			jQuery.post("person/update", // jQueryのajax通信をpostメソッドで行う。引数は、url,data,handler,dataTypeである。
					{"command":"PROPERTY",
				     "id":id, 
				     "firstName":firstName, 
				     "lastName":lastName},
				     function(data, status) {
				    	 //alert(status);
				    	 //alert(data.returncode);
				    	 if (data.returncode == 'INVALID') {
					    	 alert('VALIDATION ERROR');
				    	 }
				    	 $("#datatable").flexReload();
				     },
				     'json');
			$(this).dialog("close"); // ダイアログを閉じる。
		},
		"Cancel": function() {
			$(this).dialog("close");
		}
	}
	});

});

/*
 * 行き先の更新処理
 */ 
function update(e) {
	var target = $(e.target); // 更新された対象のオブジェクトを取得
    var col = target.parents("tr"); // 更新対象オブジェクトの親のtrタグの要素を取得する。（つまりテーブルの更新対象の行を取得したこととなる。）
    var cell = col[0].children; // 上記の子要素の配列[0]の要素を取得する。
    var id = $(cell[0]).text(); // 上記の要素の文字列を取得する。（つまり、テーブルのidの値が取得される）
    var firstName = $(cell[2]).text(); // テーブルの行の配列[2]の要素を取得する。（つまり、ファーストネームが取得される）
    //alert($(cell[2]).text() + 'の行き先を' + target.context.value + 'に変更しました。');
    jQuery.post("person/update", // jQueryのajax通信をpostメソッドで行う。（詳細は前述）
    	    {"command":"PLACE", 
	         "firstName":firstName,
	         "id":id,
	         "place":target.context.value}
	         );

    // 背景色更新（更新対象の値に応じて、cssの更新を行い、背景色を更新する）
    switch(target.context.value) {
    case 'Absent':
		$(e.target).css("background-color","red");
		break;
	case 'Present':
		$(e.target).css("background-color","yellow");
		break;
	case 'Meeting':
		$(e.target).css("background-color","pink");
	}
}

function test() {
	alert('未実装です！');
	$.get('person/create');
}

/*
 * 編集ボタンが押されたときの処理
 */
var editPressed = function(command, grid) {
	var items = $('.trSelected', grid);
	var itemlist = [];
	var id = $(items[0].cells[0]).text();
	//TODO 以下の２行は列の並べ替えをされると正しく動かなくなる。
	var firstName = $(items[0].cells[2]).text();
	var lastName = $(items[0].cells[3]).text();
	$("#id").val(id);
	$("#firstNameInput").val(firstName);
	$("#lastNameInput").val(lastName);
	$("#edit-dialog").dialog("open");
}

/*
 * 削除ボタンが押された時の処理
 */
var deletePressed = function(command, grid) {
    var items = $('.trSelected',grid);
    var itemlist = [];
    var param = $(items[0].cells[0]).text();
    $('#delete-confirm-dialog').text($(items[0].cells[2]).text() + 'を削除しますか？');
    $('#delete-confirm-dialog').dialog({
    	title:'削除確認',
    	width:400,
    	buttons:{
    		'はい':function(){
    			items.fadeOut('slow')
        		$.post('person/delete', // エラーハンドリングが必要ならば$.ajaxを使う
             		  { method:'delete',
              		   deleteItems:param},
            		   function(data, status) {
                		   if (data.returncode == 'NOTIMPLEMENT') {
                    		   alert('削除処理はサーバサイドでまだ実装されていません。');
                		   }
                		   $("#datatable").flexReload();
                	   },
         		      'json');
    			$(this).dialog("close");
				},
    		'いいえ':function() { $(this).dialog("close"); }
    	},
    	modal:true
    });
}

/*
 * flexigridの初期処理（JSONデータを受け取った後で、かつ、テーブルを表示する前に呼ばれる）
 */
function preProcess( data ) {
	$.each (data.rows,
		function(i, val) {
			val.cell[5] = val.cell[4];
			val.cell[4] = '<select id="sel" class="sel"><option value="undef">---</option><option value="Absent">Absent</option><option value="Present">Present</option><option value="Meeting">Meeting</option>';
		}
	);
	return data;
}

/*
 * flexigridの表が表示された後の処理
 */
function postProcess()  {

	// 行き先の背景色を設定する
    //var elements  = document.getElementsByClassName("drop");
    var elements  = $(".sel");
    //alert(elements.length);
	for (var i = 0; i < elements.length ; i++) {
		//[5]の値を抽出
		var col = $(elements[i]).parents("tr");
		var cell = col[0].children;
		var param = $(cell[5]).text();
		$(elements[i]).val(param);
		switch(param) {
		case 'Absent':
			$(elements[i]).css("background-color","red");
			break;
		case 'Present':
			$(elements[i]).css("background-color","yellow");
			break;
		case 'Meeting':
			$(elements[i]).css("background-color","pink");
		}
	}
}

//-->
</script>
</head>
<body>
<p>
<h3>noticeboard2011</h3>
</p>
<table id="datatable" style="display: none"></table>
<br />
<a href="person/create">create</a>
<div id="delete-confirm-dialog"></div>
<div id="edit-dialog">編集内容を入力してください。 <input type="hidden" id="id" />
<br />
FirstName <input type="text" id="firstNameInput" size="20" /> <br />
LastName <input type="text" id="lastNameInput" size="20" /></div>
</body>
</html>
}}}

=== !IndexController.java ===
{{{
package org.noticeboard2011.controller;

import java.util.ArrayList;
import java.util.List;
import java.util.logging.Logger;

import org.noticeboard2011.model.Person;
import org.noticeboard2011.service.PersonService;
import org.noticeboard2011.vo.ResultVo;
import org.slim3.controller.Navigation;

public class IndexController extends AbstractJsonController {

    static Logger logger = Logger.getLogger(IndexController.class.getName());

    private PersonService personService = new PersonService();

    @Override
    protected Navigation run() throws Exception {

        logger.fine("IndexController#run start.");

        // requestパラメータの取得
        int page = new Integer(request.getParameter("page"));
        int rp = new Integer(request.getParameter("rp"));
        String sortorder = request.getParameter("sortorder");
        String qtype = request.getParameter("qtype");
        String query = request.getParameter("query");
        logger.fine("page : " + page);
        logger.fine("rp : " + rp);
        logger.fine("sortorder : " + sortorder);
        logger.fine("qtype : " + qtype);
        logger.fine("query : " + query);

        // ページング用の開始位置の算出
        int startIndex = rp * (page - 1);

        // Datastoreからのデータ取得
        List<Person> people = getPersonList(rp, sortorder, startIndex, query);

        // JSON形式のデータ作成(for flexigrid)
        ResultVo data = generateJsonData(people);

        // JSON形式データの出力処理
        json(data);

        return null;
    }

    private List<Person> getPersonList(int rp, String sortorder, int startIndex, String query) {
       return personService.getPersonList(startIndex, rp, query, sortorder);
    }
    
    private ResultVo generateJsonData(List<Person> people) {
        ResultVo data = new ResultVo();
        data.setPage((String) request.getAttribute("page"));
        data.setTotal(personService.count(request.getParameter("query")));

        // データが入っている配列を作成する
        List array = new ArrayList();

        for (Person person : people) {
            String[] strArray = new String[5];
            strArray[0] = new Long(person.getKey().getId()).toString();
            strArray[1] = person.getVersion().toString();
            strArray[2] = person.getFirstName();
            strArray[3] = person.getLastName();
            strArray[4] = person.getPlace();
            array.add(strArray);
        }

        for (int i = 0; i < array.size(); i++) {
            data.addRow(i, (String[]) array.get(i));
        }
        return data;
    }

}

}}}

<hr/>
コード説明のTOPへ ExplanationOfSourceCode
<br/>
前のページへ CreatePerson
<br/>
次のページへ UpdatePlace