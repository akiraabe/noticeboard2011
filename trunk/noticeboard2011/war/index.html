<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>noticeboard2011</title>
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<link href="css/flexigrid/flexigrid.css" rel="stylesheet" type="text/css">
<link type="text/css" href="css/smoothness/jquery-ui-1.8.7.custom.css" rel="stylesheet" />
<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.7.custom.min.js"></script>
<script type="text/javascript" src="js/flexigrid.pack.js"></script>

<script type="text/javascript">
<!--
function _preProcess( data ) {
	$.each (data.rows,
		function(i, val) {
			val.cell[3] = val.cell[2];
			val.cell[2] = '<select id="sel" class="sel"><option value="undef">---</option><option value="Absent">Absent</option><option value="Present">Present</option><option value="Meeting">Meeting</option>';
		}
	);
	return data;
}

function update(e) {
	var target = $(e.target);
    var col = target.parents("tr");
    var cell = col[0].children;
    var param = $(cell[0]).text();
    //alert(param + $(cell[1]).text() + 'の行き先を' + target.context.value + 'に変更しました。');
    jQuery.post("person/update",{"firstName":param, "place":target.context.value});

    // 背景色更新
    switch(target.context.value) {
    case 'Absent':
		$(e.target).css("background-color","red");
		break;
	case 'Present':
		$(e.target).css("background-color","yellow");
		break;
	case 'Meeting':
		$(e.target).css("background-color","pink");
	}
}

function test() {
	alert('未実装です！');
}

$(document).ready(function() {
	$("#datatable").flexigrid({
		autoload: true,
		url: "hello",
		method: "post",
		dataType: "json",
		colModel: [
					{display: "ファーストネーム", name : "firstName", width : 150, sortable : true, align: "center"},
					{display: "ラストネーム", name : "lastName", width : 150, sortable : false, align: "center"},
					{display: "行き先", name : "place", width : 100, sortable : false, align: "center"},
					{display: "hidden", name : "place2", width : 10, sortable : false, align: "center", hide: true}
		],
		buttons : [
					{name: 'Add', bclass: 'add', onpress : test},
					{name: 'Delete', bclass: 'delete', onpress : test},
					{separator: true}
		],
		searchitems : [  
             {display: 'ファーストネーム', name : 'firstName'}
        ],  
		usepager: true,
		title: "noticeboard",
		useRp: true,
		rp: 5,
		rpOptions: [3,5,10,20],
		pagestat: "{from} ～ {to} を表示 (総数: {total} )",
		procmsg: "しばらくお待ちください……",
		nomsg: "項目はありません。",
		showTableToggleBtn: true,
		singleSelect: true,
		width: 500,
		height: "auto",
		preProcess: _preProcess
		,onSuccess: postProcess
	});

	//リストボックスで値を変更したら、update関数を呼び出す。
	$("#datatable").change(update);

});

// flexigridの表が表示された後の処理
function postProcess()  {

	// 行き先の背景色を設定する
    //var elements  = document.getElementsByClassName("drop");
    var elements  = $(".sel");
    //alert(elements.length);
	for (var i = 0; i < elements.length ; i++) {
		//[3]の値を抽出
		var col = $(elements[i]).parents("tr");
		var cell = col[0].children;
		var param = $(cell[3]).text();
		$(elements[i]).val(param);
		switch(param) {
		case 'Absent':
			$(elements[i]).css("background-color","red");
			break;
		case 'Present':
			$(elements[i]).css("background-color","yellow");
			break;
		case 'Meeting':
			$(elements[i]).css("background-color","pink");
		}
		
	}
}

//-->
</script>
</head>
<body>
<p><h3>noticeboard2011</h3></p>
<table id="datatable" style="display:none"></table>
<br/>
<a href="person/create"/>create
</body>
</html>